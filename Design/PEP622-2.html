<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>PEP 622(V2) &#8212; thautwarm&#39;s blog pages</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="DSL" href="../DSL/index.html" />
    <link rel="prev" title="My Comments about PEP 622(V1)" href="PEP622-1.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../guide.html">
          Site-32</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://github.com/thautwarm">GitHub</a></li>
                <li><a href="../PL/index.html">PL</a></li>
                <li><a href="index.html">Design</a></li>
                <li><a href="../DSL/index.html">DSL</a></li>
                <li><a href="../Fiction/index.html">Fiction</a></li>
                <li><a href="../Others/index.html">Others</a></li>
                <li><a href="../Backup/index.html">Backup</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../guide.html">Site-32 <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Site-32 Considered Harmful</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compiler/index.html">Compiler</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Design</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="General-Programming-In-Julia-Language-From-An-Advanced-Standpoint.html">General Programming In Julia Language From An Advanced Standpoint</a><ul>
<li class="toctree-l3"><a class="reference internal" href="General-Programming-In-Julia-Language-From-An-Advanced-Standpoint.html#first-class">First-Class</a></li>
<li class="toctree-l3"><a class="reference internal" href="General-Programming-In-Julia-Language-From-An-Advanced-Standpoint.html#polymorphisms-of-multiple-dispatch">Polymorphisms of Multiple Dispatch</a></li>
<li class="toctree-l3"><a class="reference internal" href="General-Programming-In-Julia-Language-From-An-Advanced-Standpoint.html#full-featured-macros">Full-Featured Macros</a><ul>
<li class="toctree-l4"><a class="reference internal" href="General-Programming-In-Julia-Language-From-An-Advanced-Standpoint.html#macro-the-function-from-ast-to-ast">Macro, the Function from AST to AST</a></li>
<li class="toctree-l4"><a class="reference internal" href="General-Programming-In-Julia-Language-From-An-Advanced-Standpoint.html#scope-and-hygiene">Scope and Hygiene</a></li>
<li class="toctree-l4"><a class="reference internal" href="General-Programming-In-Julia-Language-From-An-Advanced-Standpoint.html#other-useful-knowledge-for-julia-macros">Other Useful Knowledge for Julia Macros</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="General-Programming-In-Julia-Language-From-An-Advanced-Standpoint.html#a-big-step-forward-in-ast-manipulations">A Big Step Forward in AST Manipulations</a></li>
<li class="toctree-l3"><a class="reference internal" href="General-Programming-In-Julia-Language-From-An-Advanced-Standpoint.html#limitation-absence-of-function-types">Limitation: Absence of Function Types</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Some-Thoughts-About-The-RestrainJIT.html">Some Thoughts About The Restrain JIT</a></li>
<li class="toctree-l2"><a class="reference internal" href="Research-Restrain-JIT.html">Research: Review and Observations of Python JIT</a><ul>
<li class="toctree-l3"><a class="reference internal" href="Research-Restrain-JIT.html#history">History</a></li>
<li class="toctree-l3"><a class="reference internal" href="Research-Restrain-JIT.html#observations">Observations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="PEP622-1.html">My Comments about PEP 622(V1)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="PEP622-1.html#my-concerns">My Concerns</a></li>
<li class="toctree-l3"><a class="reference internal" href="PEP622-1.html#scoping-issues">Scoping Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="PEP622-1.html#comments-about-the-rejection-of-and-patterns">Comments about the rejection of AND (&amp;) patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="PEP622-1.html#consider-performance-guards-as-patterns">Consider Performance: Guards As Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="PEP622-1.html#grammar-change-feature-request-parameterized-patterns">Grammar Change &amp; Feature Request: Parameterized Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="PEP622-1.html#an-alternative-match-protocol-can-be-better-in-simplicity-efficiency-and-expressivity">An Alternative <code class="docutils literal notranslate"><span class="pre">__match__</span></code> Protocol Can be Better in Simplicity, Efficiency, and Expressivity.</a><ul>
<li class="toctree-l4"><a class="reference internal" href="PEP622-1.html#simplicity-of-the-alternative-match-protocol">Simplicity of the alternative <code class="docutils literal notranslate"><span class="pre">__match__</span></code> protocol</a></li>
<li class="toctree-l4"><a class="reference internal" href="PEP622-1.html#the-alternative-match-protocol-is-efficient">The alternative <code class="docutils literal notranslate"><span class="pre">__match__</span></code> protocol is efficient</a></li>
<li class="toctree-l4"><a class="reference internal" href="PEP622-1.html#the-alternative-match-protocol-results-in-better-expressivity">The alternative <code class="docutils literal notranslate"><span class="pre">__match__</span></code> protocol results in better expressivity</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="PEP622-1.html#miscellaneous">Miscellaneous</a><ul>
<li class="toctree-l4"><a class="reference internal" href="PEP622-1.html#else-clauses-in-pattern-matching"><code class="docutils literal notranslate"><span class="pre">else</span></code> Clauses in Pattern Matching</a></li>
<li class="toctree-l4"><a class="reference internal" href="PEP622-1.html#grammar-of-patterns-could-become-that-of-expressions">Grammar of Patterns Could Become That of Expressions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">PEP 622(V2)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#bringing-else-back-is-rejected">Bringing <code class="docutils literal notranslate"><span class="pre">else</span></code> Back is Rejected</a></li>
<li class="toctree-l3"><a class="reference internal" href="#variables-in-patterns-bindings-instead-of-evaluations-and-comparisons">Variables in Patterns: Bindings instead of Evaluations and Comparisons</a></li>
<li class="toctree-l3"><a class="reference internal" href="#alternative-match-protocol">Alternative <code class="docutils literal notranslate"><span class="pre">__match__</span></code> Protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-switch-semantics">The Switch Semantics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#scope">Scope</a></li>
<li class="toctree-l3"><a class="reference internal" href="#miscellaneous">Miscellaneous</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../DSL/index.html">DSL</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../DSL/write-your-a-query-language-with-MLStyle.html">Write You A Query Language</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../DSL/write-your-a-query-language-with-MLStyle.html#definition-of-syntaxes">Definition of Syntaxes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../DSL/write-your-a-query-language-with-MLStyle.html#codegen-target">Codegen Target</a></li>
<li class="toctree-l3"><a class="reference internal" href="../DSL/write-your-a-query-language-with-MLStyle.html#refinement-of-codegen-typed-columns">Refinement of Codegen: Typed Columns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../DSL/write-your-a-query-language-with-MLStyle.html#implementation">Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../DSL/write-your-a-query-language-with-MLStyle.html#enjoy-you-a-query-language">Enjoy You A Query Language</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Fiction/index.html">Fiction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Fiction/index.html#id1">2021年4月</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fiction/index.html#id3">2020年10月</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fiction/index.html#id4">2020年6月</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fiction/index.html#id7">2020年4月</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fiction/index.html#id9">2019年10月</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Fiction/index.html#id10">日前安排</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Fiction/index.html#id18">目录</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../Fiction/日记2019-10-13.html">Smarter Witnesses for Type Classes</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2019-10-13.html#notation">Notation</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2019-10-13.html#instance-resolution-variables-as-instances">Instance Resolution &amp; Variables As Instances</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2019-10-13.html#the-most-general-instance-problem-overlapping-instance-problem">“The Most General Instance” Problem &amp; “Overlapping Instance” Problem</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2019-10-13.html#id1">优化</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2019-10-13.html#id2">该算法和相应语言设计的好处</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2019-10-13.html#id3">不足之处</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../Fiction/日记2019-10-15.html">我和Python的故事</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2019-10-15.html#id1">第0节</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2019-10-15.html#id2">第1节: 科学计算, Python, 生物信息学和数据挖掘</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2019-10-15.html#id3">第2节: 转型的经过, 走向程序语言设计领域</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2019-10-15.html#id4">第3节: 想要给Python添加高级语言特性的理想</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2019-10-15.html#id5">第4节: Flowpython</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2019-10-15.html#bnf-parser-generator">第4节: BNF, Parser Generator和语言制造机器</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../Fiction/日记2019-10-30.html">杂谈</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2019-10-30.html#pycon-china-2019">PyCon China 2019 成都</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2019-10-30.html#id2">直面自己的人格缺陷</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../Fiction/日记2019-11-06.html">杂谈</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Fiction/日记2019-11-14.html">我太难了</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Fiction/日记2019-11-17.html">我太懂了</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Fiction/日记2020-01-07.html">打通</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2020-01-07.html#parsing">Parsing</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2020-01-07.html#python">Python 字节码</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../Fiction/日记2020-02-02.html">Tagless Final in F#</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Fiction/日记2020-02-07.html">Encoding Typeclass Default Methods in Purescript</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Fiction/日记2020-02-11.html">近期规划</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/日记2020-02-11.html#purescript-python">Purescript-Python</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../Fiction/日记2020-02-11.html#anf">从表达式优先到语句优先: ANF变换</a></li>
<li class="toctree-l6"><a class="reference internal" href="../Fiction/日记2020-02-11.html#pythonfirst-class">Python虚拟机上的First-class的表达式优先</a></li>
<li class="toctree-l6"><a class="reference internal" href="../Fiction/日记2020-02-11.html#id2">社区意见</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../Fiction/cure/和平日久.html">如何写出令人感到幸福的小说</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/cure/和平日久.html#id2">合理利用“无敌”元素</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/cure/和平日久.html#id3">“纯爱”而非“后宫”</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/cure/和平日久.html#id4">细腻的画面感</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/cure/和平日久.html#id5">节奏流畅的回忆</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/cure/和平日久.html#id6">暗线和潜台词</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/cure/和平日久.html#id7">总结</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../Fiction/cure/乐理菜鸡怎么给自己的小说写bgm.html">乐理菜鸡怎么给自己的小说写BGM?</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/cure/乐理菜鸡怎么给自己的小说写bgm.html#id1">找调</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/cure/乐理菜鸡怎么给自己的小说写bgm.html#id2">打谱</a></li>
<li class="toctree-l5"><a class="reference internal" href="../Fiction/cure/乐理菜鸡怎么给自己的小说写bgm.html#id3">总结</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../PL/index.html">Programming Language</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../PL/HKT.html">Higher Kinded Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../PL/typeclass.html">Type Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../PL/typeclass.html#about-abstractions">About Abstractions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/typeclass.html#about-separation-of-type-definitions-and-data-manipulations">About Separation of Type Definitions and Data Manipulations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../PL/paper-reading-LHKP.html">Paper Reading: Lightweight-Higher-Kinded-Polymorphism</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../PL/paper-reading-LHKP.html#how-to">How-To</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/paper-reading-LHKP.html#static-resolution-more-polymorphic">Static Resolution: More polymorphic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/paper-reading-LHKP.html#limitation1-much-higher-kinded">Limitation1: Much Higher Kinded</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/paper-reading-LHKP.html#limitation2-identity">Limitation2: Identity</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/paper-reading-LHKP.html#why-this-lightweight-higher-polymorphism-instead-of-the-haskell-approach">Why this Lightweight-Higher-Polymorphism instead of the Haskell approach</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../PL/HKT-typeclass-FSharp.html">Compelling Higher Kinded Types and Type Classes in F#</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../PL/HKT-typeclass-FSharp.html#active-pattern">Active Pattern</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/HKT-typeclass-FSharp.html#statically-resolved-type-parameters">Statically Resolved Type Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/HKT-typeclass-FSharp.html#the-getsig-function-and-implicits">The <em>getsig</em> Function and Implicits</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/HKT-typeclass-FSharp.html#why-abstractclass">Why AbstractClass?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/HKT-typeclass-FSharp.html#why-functor-f-instead-of-the-straightforward-functor">Why <em>Functor&lt;’F&gt;</em> instead of the straightforward <em>Functor</em></a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/HKT-typeclass-FSharp.html#references-and-further-reading">References and Further Reading</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../PL/plfp-20191212.html">FSYM: An Abstraction On Tagless-Final Style To Compositing And Decoupling Multiple Interpretations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../PL/plfp-20191212.html#terminology">Terminology</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/plfp-20191212.html#background">Background</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/plfp-20191212.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/plfp-20191212.html#application">Application</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../PL/plfp-20191212.html#scoping-name-resolution">Scoping: Name Resolution</a></li>
<li class="toctree-l4"><a class="reference internal" href="../PL/plfp-20191212.html#typing-type-inference">Typing: Type Inference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../PL/plfp-20191212.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../PL/plfp-20191219.html">Tagless Final For Writing Compilers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../PL/plfp-20191219.html#problem">Problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/plfp-20191219.html#tagless-final-for-compiler-phases">Tagless Final For Compiler Phases</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../PL/plfp-20191219.html#quick-start-for-tagless-final">Quick Start for Tagless Final</a></li>
<li class="toctree-l4"><a class="reference internal" href="../PL/plfp-20191219.html#grammar">“Grammar”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../PL/plfp-20191219.html#expanding-representation">Expanding Representation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../PL/plfp-20191219.html#problems-of-decoupling-and-compositing">Problems of Decoupling and Compositing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../PL/plfp-20191219.html#fsym">FSYM</a></li>
<li class="toctree-l4"><a class="reference internal" href="../PL/plfp-20191219.html#laziness-for-mutual-dependencies">Laziness, for Mutual Dependencies</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../PL/plfp-20191219.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../PL/elaborating-julia.html">Julia Counts for PL Researchers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../PL/elaborating-julia.html#expressiveness">Expressiveness</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/elaborating-julia.html#staging">Staging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/elaborating-julia.html#advantages-as-a-codegen-backend">Advantages as a codegen backend</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../PL/tagless-final-pattern-match.html">First-class Pattern Matching in the Final Approach</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../PL/tagless-final-pattern-match.html#core-ideas">Core Ideas</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/tagless-final-pattern-match.html#full-implementation-in-haskell">Full implementation in Haskell</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/tagless-final-pattern-match.html#enhancement-1">Enhancement 1</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../PL/tagless-final-for-julia.html">Julia Benefits from Tagless Final</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../PL/tagless-final-for-julia.html#what-happened-today">What Happened Today?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/tagless-final-for-julia.html#an-example-turns-out-to-be-type-unstable">An Example Turns Out to be Type Unstable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/tagless-final-for-julia.html#tagless-final-encoding-about-above-code">Tagless Final Encoding about Above Code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../PL/hrt-use-case.html">Some Use Cases for Higher Rank Polymorphisms(No Monad)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../PL/hrt-use-case.html#polymorphic-functions-for-edsl">Polymorphic Functions for eDSL</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/hrt-use-case.html#existential-types">Existential Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PL/hrt-use-case.html#manipulation-for-heterogeneous-data">Manipulation for Heterogeneous Data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Backup/index.html">Backup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Backup/高观点下的Julia泛用编程.html">高观点下的Julia泛用编程</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Others/index.html">Others</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Others/contributions.html">Thautwarm’s Open Source Contributions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Others/contributions.html#projects-owned-by-other-individuals-organizations">Projects Owned By Other Individuals/Organizations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Others/contributions.html#leading-projects">Leading Projects</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Others/contributions.html#other-notable-personal-projects">Other Notable Personal Projects</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Subsections <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">PEP 622(V2)</a><ul>
<li><a class="reference internal" href="#bringing-else-back-is-rejected">Bringing <code class="docutils literal notranslate"><span class="pre">else</span></code> Back is Rejected</a></li>
<li><a class="reference internal" href="#variables-in-patterns-bindings-instead-of-evaluations-and-comparisons">Variables in Patterns: Bindings instead of Evaluations and Comparisons</a></li>
<li><a class="reference internal" href="#alternative-match-protocol">Alternative <code class="docutils literal notranslate"><span class="pre">__match__</span></code> Protocol</a></li>
<li><a class="reference internal" href="#the-switch-semantics">The Switch Semantics</a></li>
<li><a class="reference internal" href="#scope">Scope</a></li>
<li><a class="reference internal" href="#miscellaneous">Miscellaneous</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="section" id="pep-622-v2">
<h1>PEP 622(V2)<a class="headerlink" href="#pep-622-v2" title="Permalink to this headline">¶</a></h1>
<div class="section" id="bringing-else-back-is-rejected">
<h2>Bringing <code class="docutils literal notranslate"><span class="pre">else</span></code> Back is Rejected<a class="headerlink" href="#bringing-else-back-is-rejected" title="Permalink to this headline">¶</a></h2>
<p>The main reason why people cannot converge on this is the problem of indentation setting.</p>
<p>Although other control flow statements in Python can have an <code class="docutils literal notranslate"><span class="pre">else</span></code> clause, when putting an <code class="docutils literal notranslate"><span class="pre">else</span></code>
to match statements, there’re several options:</p>
<ol>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">else</span></code> alighed with <code class="docutils literal notranslate"><span class="pre">case</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">match</span> <span class="n">expr</span><span class="p">:</span>
   <span class="n">case</span> <span class="n">pat1</span><span class="p">:</span>
       <span class="o">...</span>
   <span class="n">case</span> <span class="n">pat2</span><span class="p">:</span>
       <span class="o">...</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="o">...</span>    
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">else</span></code> alighed with <code class="docutils literal notranslate"><span class="pre">match</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">match</span> <span class="n">expr</span><span class="p">:</span>
   <span class="n">case</span> <span class="n">pat1</span><span class="p">:</span>
       <span class="o">...</span>
   <span class="n">case</span> <span class="n">pat2</span><span class="p">:</span>
       <span class="o">...</span>
<span class="k">else</span><span class="p">:</span>
   <span class="o">...</span>    
</pre></div>
</div>
</li>
<li><p class="first">Both..</p>
</li>
</ol>
<p>This proposal has been rejeted as said <a class="reference external" href="https://github.com/gvanrossum/patma/issues/89#issuecomment-652782965">here</a>.</p>
<blockquote>
<div><p>I propose that we reject this idea. The reasoning should be</p>
<ul class="simple">
<li>case _: works just fine</li>
<li>There will forever be confusion(*) about the indentation level of the else:</li>
<li>“Completionist” arguments like “every other statement has one” are pretty useless (and false)</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="variables-in-patterns-bindings-instead-of-evaluations-and-comparisons">
<h2>Variables in Patterns: Bindings instead of Evaluations and Comparisons<a class="headerlink" href="#variables-in-patterns-bindings-instead-of-evaluations-and-comparisons" title="Permalink to this headline">¶</a></h2>
<p>The concerned issue is <a class="reference external" href="https://github.com/gvanrossum/patma/issues/90">#90</a>.</p>
<p>Some of the community feel terrible about the following code</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Bar</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">match</span> <span class="n">x</span><span class="p">:</span>
    <span class="n">case</span> <span class="n">Bar</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>That they think binding <code class="docutils literal notranslate"><span class="pre">x</span></code> to <code class="docutils literal notranslate"><span class="pre">Bar</span></code> might not be a good semantics,
instead, checking if <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">==</span> <span class="pre">Bar</span></code> might be better.</p>
<p>The progress of this is, people converged to <code class="docutils literal notranslate"><span class="pre">a.b</span></code> means comparing matching target with <code class="docutils literal notranslate"><span class="pre">a.b</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">.b</span></code> is out.</p>
<p>As the uppercase conventions to indicate enumerations in quite many programming languages,
an idea to use an uppercase name for loading variables instead of binding variables were
came up with. This seems nearly rejected by PEP 622 authors.</p>
<p>The use of uppercase names are not restricted in Python during these years. It’s certainly not a good
option to make them behave as those in Haskell/ML/Scala.</p>
</div>
<div class="section" id="alternative-match-protocol">
<h2>Alternative <code class="docutils literal notranslate"><span class="pre">__match__</span></code> Protocol<a class="headerlink" href="#alternative-match-protocol" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/gvanrossum/patma/issues/100">#100</a> by me is rejected.</p>
<p><a class="reference external" href="https://github.com/gvanrossum/patma/issues/8#issuecomment-616354418">A similar proposal</a> is already made in the early stage(but I have to say they’re not identical),
and <a class="reference external" href="https://github.com/gvanrossum/patma/issues/8#issuecomment-618688792">the reason why Guido rejected it</a>.</p>
<p>The previously accepted one is more memory efficient, while this alternative one can be faster and more flexible.</p>
<p>Further, <a class="reference external" href="https://github.com/gvanrossum/patma/issues/115">the <code class="docutils literal notranslate"><span class="pre">__match__</span></code> protocol is now ditched</a>.</p>
<p>I’m actually in favor of this.</p>
<p><code class="docutils literal notranslate"><span class="pre">__match__</span></code> will after all enable something like AND patterns and active patterns in F#.</p>
<p>Of course I love active patterns, because I used it a lot in F#, which is quite useful in compiler works
and web development, as it provides user-friendly options to express domain concepts into the programming part.</p>
<p>So far, <a class="reference external" href="https://github.com/gvanrossum/patma/issues/97#issuecomment-649875519">PEP 622 authors are negative towards the benefits of AND patterns and active patterns</a>.</p>
<p>Hence, in order to actually disable AND patterns and active patterns,
it’s good to ditch <code class="docutils literal notranslate"><span class="pre">__match__</span></code> and everything will get fine. There’re many good concerns presented in <a class="reference external" href="https://github.com/gvanrossum/patma/issues/115">#115</a>,
say, no <code class="docutils literal notranslate"><span class="pre">__match__</span></code> still works for many exemlar use cases discovered by PEP 622 authors,
and we can add a proper <code class="docutils literal notranslate"><span class="pre">__match__</span></code> protocol later if users actually need it and call for it.</p>
</div>
<div class="section" id="the-switch-semantics">
<h2>The Switch Semantics<a class="headerlink" href="#the-switch-semantics" title="Permalink to this headline">¶</a></h2>
<p>As I used to overwhelming the tracker repository, I stopped posting more proposals.</p>
<p>One of which is the switch semantics, which could speed up pattern matching in some cases.</p>
<p>This could be achieved by <strong>Label As Value</strong>, just like how switch/match things got implemented in a static language.</p>
<p>In Python we also have <strong>Label As Value</strong>, by using the Python bytecode instruction <a class="reference external" href="https://docs.python.org/3/library/dis.html#opcode-END_FINALLY"><strong>END_FINALLY</strong></a>.</p>
<p>I was told about this by <a class="reference external" href="https://github.com/bhuztez">&#64;bhuztez</a>, and he seems to know this from <a class="reference external" href="https://code.lardcave.net/2009/07/27/135526/">GOSUB</a>.</p>
<p>Besides, I’ve made an intermediate language implementing this feature, compiling to Python bytecode:</p>
<p><a class="reference external" href="https://sijuiacion-lang.readthedocs.io/en/latest/instructions.html#indir">Sijuiacion Language</a>.</p>
<div class="highlight-sijuiacion notranslate"><div class="highlight"><pre><span></span><span class="k">label</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="n">...</span><span class="w"></span>
<span class="k">blockaddr</span><span class="w"> </span><span class="n">a</span><span class="w">  </span><span class="l"># get the address of label a</span>
<span class="k">indir</span><span class="w">        </span><span class="l"># according to TOS(top of stack), jump to some label </span>
</pre></div>
</div>
<p>In above code, we use <code class="docutils literal notranslate"><span class="pre">label</span> <span class="pre">a</span></code>, define a label, it will have an offset <code class="docutils literal notranslate"><span class="pre">I&lt;a&gt;</span></code> among all instructions in the same function.</p>
<p>You can use <code class="docutils literal notranslate"><span class="pre">goto</span> <span class="pre">a</span></code> to jump to label <code class="docutils literal notranslate"><span class="pre">a</span></code> directly.</p>
<p>However, for pattern matching or switch cases, an indirect jump can be performant.</p>
<p><code class="docutils literal notranslate"><span class="pre">blockaddr</span> <span class="pre">a</span></code> will access the offset of label <code class="docutils literal notranslate"><span class="pre">a</span></code> in the whole instructions, and push it to TOS;</p>
<p><code class="docutils literal notranslate"><span class="pre">indir</span></code> consumes TOS, and jump to the corresponding offset.</p>
<p>Above sijuiacion things will be compiled to CPython bytecode instructions with the help of <code class="docutils literal notranslate"><span class="pre">END_FINALLY</span></code>.</p>
<p>If we have such a match statement:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">match</span> <span class="n">expr</span><span class="p">:</span>
    <span class="n">case</span> <span class="n">C1</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="c1"># block 1</span>
        <span class="o">...</span>
    <span class="n">case</span> <span class="n">C2</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="c1"># block 2</span>
        <span class="o">...</span>
    <span class="n">case</span> <span class="n">C2</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="c1"># block 3</span>
        <span class="o">...</span>
    <span class="n">case</span> <span class="n">C3</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="c1"># block 4</span>
    <span class="n">case</span> <span class="n">_</span><span class="p">:</span>
        <span class="c1"># block 5</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>And if we can know some static and unique <em>tags</em> held by <code class="docutils literal notranslate"><span class="pre">C1</span></code>, <code class="docutils literal notranslate"><span class="pre">C2</span></code>, …,
we can generate a constant table <code class="docutils literal notranslate"><span class="pre">TABLE</span> <span class="pre">=</span> <span class="pre">{tag(C1):</span> <span class="pre">&lt;blockaddr</span> <span class="pre">1&gt;,</span> <span class="pre">tag(C2):</span> <span class="pre">&lt;blockaddr</span> <span class="pre">2&gt;,</span> <span class="pre">tag(C3):</span> <span class="pre">&lt;blockaddr</span> <span class="pre">4&gt;}</span></code>,
we could generate such instructions:</p>
<div class="highlight-sijuiacion notranslate"><div class="highlight"><pre><span></span><span class="n">LOAD_CONST</span><span class="w"> </span><span class="err">&lt;</span><span class="n">TABLE</span><span class="err">&gt;</span><span class="w"></span>
<span class="l"># we compute the label value and push it ot TOS</span>
<span class="err">&lt;</span><span class="k">call</span><span class="w"> </span><span class="n">dict.get</span><span class="err">(</span><span class="n">TABLE</span><span class="err">,</span><span class="w"> </span><span class="n">tag</span><span class="err">(</span><span class="n">match_target</span><span class="err">),</span><span class="w"> </span><span class="err">&lt;</span><span class="k">blockaddr</span><span class="w"> </span><span class="m">5</span><span class="err">&gt;)&gt;</span><span class="w"> </span>
<span class="k">indir</span><span class="w">  </span><span class="l"># indirect jump according to TOS</span>
</pre></div>
</div>
<p>In this way, we can very fast decide which cases are possible to try.</p>
<p>However, a global variable like <code class="docutils literal notranslate"><span class="pre">C1</span></code>, <code class="docutils literal notranslate"><span class="pre">C2</span></code>, <code class="docutils literal notranslate"><span class="pre">C3</span></code> is actually dynamic variables in Python,
this will cause it difficult to create a jump table.</p>
<p>Besides, active patterns will disable such optimizations.</p>
</div>
<div class="section" id="scope">
<h2>Scope<a class="headerlink" href="#scope" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/gvanrossum/patma/issues/96">#96</a> is shutdown as
PEP 622 authors didn’t agree that this was an issue.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span>  <span class="mi">1</span>
<span class="n">match</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
    <span class="n">case</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="o">...</span>
    <span class="n">case</span> <span class="n">_</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="c1"># 1 or 10?</span>
</pre></div>
</div>
<p>Some concern against using name shadowing technique is,
<code class="docutils literal notranslate"><span class="pre">locals</span></code> and other Python reflection things are already widely used to access local names,
and it might be difficult to predict where the lifetime of a variable has ended up.</p>
<p>This is not a problem, because name shadowing just generates some “weird” names, and statically
shadows some existing variables.</p>
<p>Its implementation within the CPython codebase can be easily made when building symbol tables,
or building bytecode instructions.</p>
<p>I can make a demonstration for name shadowing steps based on the following code, and assume that
we perform this when building bytecode instructions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">match</span> <span class="n">expr</span><span class="p">:</span>
    <span class="n">case</span> <span class="n">C</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="o">...</span>
</pre></div>
</div>
<ol class="simple">
<li>We create an empty map <code class="docutils literal notranslate"><span class="pre">ENV</span></code>, from user-written names to generated names.</li>
<li>When visiting the sub-patterns of <code class="docutils literal notranslate"><span class="pre">C(a,</span> <span class="pre">1)</span></code>, we saw <code class="docutils literal notranslate"><span class="pre">a</span></code>, we generate some name for <code class="docutils literal notranslate"><span class="pre">a</span></code>, maybe
<code class="docutils literal notranslate"><span class="pre">$a.h&#64;z</span></code>, which shall be an invalid Python identifier. We add the mapping to <code class="docutils literal notranslate"><span class="pre">ENV</span></code>(<code class="docutils literal notranslate"><span class="pre">ENV[a</span> <span class="pre">:=</span> <span class="pre">$a.h&#64;z]</span></code>).</li>
<li>When visiting the name <code class="docutils literal notranslate"><span class="pre">a</span></code> in the guard <code class="docutils literal notranslate"><span class="pre">(lambda</span> <span class="pre">:</span> <span class="pre">a</span> <span class="pre">&lt;</span> <span class="pre">2)()</span></code>, we lookup <code class="docutils literal notranslate"><span class="pre">ENV</span></code>(<code class="docutils literal notranslate"><span class="pre">ENV.get(&quot;a&quot;,</span> <span class="pre">&quot;a&quot;)</span></code>),
hence we will actually get the generated name <code class="docutils literal notranslate"><span class="pre">&quot;$a.h&#64;z&quot;</span></code> here.</li>
<li>If the case <code class="docutils literal notranslate"><span class="pre">C(a,</span> <span class="pre">1)</span> <span class="pre">if</span> <span class="pre">(lambda</span> <span class="pre">:</span> <span class="pre">a</span> <span class="pre">&lt;</span> <span class="pre">2)()</span></code> failed, we just exit it. Notice that variable <code class="docutils literal notranslate"><span class="pre">a</span></code> is not bound,</li>
<li>Otherwise, before <code class="docutils literal notranslate"><span class="pre">print(a)</span></code>, we inserted instructions to do name bindings <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">$a.h&#64;z</span></code>.</li>
</ol>
<p>As you can see, name shadowing can also be totally made with AST transformations
(this can be better as you don’t need to care about whether a variable is (cell)bound/free/global):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>a = 1
match expr:
    case C($a.h@z, 1) if (lambda : $a.h@z &lt; 2)():
        a = $a.h@z
        print(a)
        ...
</pre></div>
</div>
<p>How about <code class="docutils literal notranslate"><span class="pre">locals</span></code>? Or other reflection tools?</p>
<p>Fine. The generated are invalid identifiers, you can just skip them.</p>
<p>However, it’s rejected after all. <a class="reference external" href="https://github.com/gvanrossum/patma/issues/110">This semantics is already clarified</a>
in some degree, in PEP 622.</p>
</div>
<div class="section" id="miscellaneous">
<h2>Miscellaneous<a class="headerlink" href="#miscellaneous" title="Permalink to this headline">¶</a></h2>
<p>I forgot them. TODO.</p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../_sources/Design/PEP622-2.md.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2020, thautwarm.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>